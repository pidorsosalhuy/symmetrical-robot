name: VNC via Cloudflare TCP Tunnel

on: [workflow_dispatch]

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Install VNC
      run: |
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi" -OutFile "tightvnc.msi"
        Start-Process msiexec -ArgumentList "/i tightvnc.msi /quiet /norestart" -Wait
        Start-Sleep -Seconds 10
        $vncPath = "C:\Program Files\TightVNC\tvnserver.exe"
        & "$vncPath" -service -start
        Start-Sleep -Seconds 5
        & "$vncPath" -controlservice -password Pass123!

    - name: Install Cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: Create TCP Tunnel
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º API —Ç–æ–∫–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ —á–µ—Ä–µ–∑ env)
        # –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
        $tunnelName = "vnc-${{ github.run_id }}-${{ github.run_attempt }}"
        Write-Host "Creating tunnel: $tunnelName"

        # –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –∏ –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ ID
        .\cloudflared.exe tunnel create $tunnelName
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TCP —Ç—Ä–∞—Ñ–∏–∫–∞
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è
        $tunnelConfig = @"
tunnel: $tunnelName
credentials-file: .cloudflared/$tunnelName.json
ingress:
  - hostname: $tunnelName.try.cloudflare.com
    service: tcp://localhost:5900
  - service: http_status:404
"@
        $tunnelConfig | Out-File -FilePath "config.yml" -Encoding ASCII

        # –ù–∞–∑–Ω–∞—á–∞–µ–º DNS –∑–∞–ø–∏—Å—å –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è
        .\cloudflared.exe tunnel route dns $tunnelName $tunnelName

        Write-Host "Tunnel created and DNS configured"

    - name: Run Tunnel
      run: |
        $tunnelName = "vnc-${{ github.run_id }}-${{ github.run_attempt }}"
        Write-Host "================================================"
        Write-Host "üöÄ VNC TUNNEL STARTED"
        Write-Host "VNC Address: $tunnelName.try.cloudflare.com:5900"
        Write-Host "VNC Password: Pass123!"
        Write-Host "================================================"

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å
        .\cloudflared.exe tunnel run $tunnelName
