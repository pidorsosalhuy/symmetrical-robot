name: Serveo Tunnel with Split Workspace

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  serveo:
    runs-on: ubuntu-latest
    timeout-minutes: 355

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Restore workspace
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‡Ð°ÑÑ‚Ð¸ Ð²Ð¾Ñ€ÐºÑÐ¿ÐµÐ¹ÑÐ°
        if ls workspace_part_* 1> /dev/null 2>&1; then
          echo "âœ… Restoring workspace from parts..."
          cat workspace_part_* | tar -xzf - -C /home/runner/
          echo "âœ… Workspace restored"
        else
          echo "ðŸ†• No previous workspace found"
        fi

    - name: Install and setup SSH server
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server openssh-client
        
        sudo useradd -m -s /bin/bash none
        echo "none:h4ck3d" | sudo chpasswd
        sudo usermod -aG sudo none
        echo "none ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/none
        
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
        echo "AllowUsers none" | sudo tee -a /etc/ssh/sshd_config
        
        sudo service ssh start

    - name: Start Serveo tunnel
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Serveo Ð² Ñ„Ð¾Ð½Ðµ
        ssh -o StrictHostKeyChecking=no -R github-runner:22:localhost:22 serveo.net &
        SERVEOPID=$!
        
        # Ð–Ð´ÐµÐ¼ 5 Ñ‡Ð°ÑÐ¾Ð² 55 Ð¼Ð¸Ð½ÑƒÑ‚
        sleep 21300
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ð¾Ñ€ÐºÑÐ¿ÐµÐ¹Ñ Ñ ÑƒÐ¼Ð½Ñ‹Ð¼ Ñ€Ð°Ð·Ð±Ð¸Ñ‚Ð¸ÐµÐ¼
        echo "ðŸ’¾ Saving workspace with smart splitting..."
        
        # ÐžÑ†ÐµÐ½Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð²Ð¾Ñ€ÐºÑÐ¿ÐµÐ¹ÑÐ°
        SIZE=$(du -sb /home/none/ | cut -f1)
        echo "Workspace size: $SIZE bytes"
        
        # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ‡Ð°ÑÑ‚Ð¸ (Ð¼Ð°ÐºÑ 500MB Ð½Ð° Ñ‡Ð°ÑÑ‚ÑŒ)
        PART_SIZE=500000000  # 500MB Ð² Ð±Ð°Ð¹Ñ‚Ð°Ñ…
        NEEDED_PARTS=$(( (SIZE + PART_SIZE - 1) / PART_SIZE ))
        
        # ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 1 Ñ‡Ð°ÑÑ‚ÑŒ, Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 20 Ñ‡Ð°ÑÑ‚ÐµÐ¹ (10GB)
        if [ $NEEDED_PARTS -lt 1 ]; then
          NEEDED_PARTS=1
        fi
        if [ $NEEDED_PARTS -gt 20 ]; then
          NEEDED_PARTS=20
        fi
        
        ACTUAL_PART_SIZE=$(( (SIZE + NEEDED_PARTS - 1) / NEEDED_PARTS ))
        
        echo "Splitting into $NEEDED_PARTS parts (~$((ACTUAL_PART_SIZE/1000000))MB each)"
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸
        rm -f workspace_part_*
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸
        tar -czf - /home/none/ | split -b ${ACTUAL_PART_SIZE} - workspace_part_
        
        # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ñ‡Ð°ÑÑ‚Ð¸
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        git add workspace_part_*
        git commit -m "Workspace split into $NEEDED_PARTS parts ($((SIZE/1000000))MB total)" || echo "No changes"
        git push
        
        # Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Serveo Ñ‡Ñ‚Ð¾Ð±Ñ‹ workflow Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ
        kill $SERVEOPID 2>/dev/null || true

    - name: Trigger restart
      if: always()
      run: |
        echo "ðŸ”„ Triggering restart..."
        curl -X POST \
          -H "Authorization: token ${{ secrets.AUTO_RESTART_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml/dispatches" \
          -d '{"ref":"${{ github.ref }}"}'
