name: Serveo Tunnel with Smart Workspace

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  serveo:
    runs-on: ubuntu-latest
    timeout-minutes: 355

    steps:
    - name: Checkout with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ð’Ð°Ð¶Ð½Ð¾! ÐšÐ°Ñ‡Ð°ÐµÐ¼ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²

    - name: Restore workspace
      run: |
        echo "ðŸ” Looking for workspace parts..."
        if ls workspace_part_* 1> /dev/null 2>&1; then
          echo "âœ… Found workspace parts, restoring..."
          cat workspace_part_* | tar -xzf - -C /
          echo "âœ… Workspace restored to /home/none/"
        else
          echo "ðŸ†• No workspace parts found, starting fresh"
        fi

    - name: Setup system and user
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server openssh-client pwgen
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ none ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if ! id "none" &>/dev/null; then
          sudo useradd -m -s /bin/bash none
          echo "none:h4ck3d" | sudo chpasswd
          sudo usermod -aG sudo none
          echo "none ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/none
        fi
        
        # ÐœÐµÐ½ÑÐµÐ¼ hostname
        sudo hostnamectl set-hostname gitserver
        
        # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ SSH
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
        echo "AllowUsers none" | sudo tee -a /etc/ssh/sshd_config
        
        # Ð§Ð¸Ð½Ð¸Ð¼ Ð¿Ñ€Ð°Ð²Ð°
        sudo chown -R none:none /home/none/
        sudo service ssh restart

    - name: Start Serveo tunnel with auto-save
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Serveo Ð² Ñ„Ð¾Ð½Ðµ
        ssh -o StrictHostKeyChecking=no -R github-runner:22:localhost:22 serveo.net &
        SERVEOPID=$!
        echo "ðŸ”„ Serveo started with PID: $SERVEOPID"
        
        # Ð–Ð´ÐµÐ¼ 5 Ñ‡Ð°ÑÐ¾Ð² 50 Ð¼Ð¸Ð½ÑƒÑ‚ Ð¿ÐµÑ€ÐµÐ´ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼
        sleep 21000
        
        echo "ðŸ’¾ Starting workspace save..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
        sudo tar -czf /tmp/workspace_backup.tar.gz -C /home/none/ .
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¸ Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° Ñ‡Ð°ÑÑ‚Ð¸
        SIZE=$(stat -c%s /tmp/workspace_backup.tar.gz)
        PART_SIZE=50000000  # 50MB Ñ‡Ð°ÑÑ‚Ð¸ Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸
        NEEDED_PARTS=$(( (SIZE + PART_SIZE - 1) / PART_SIZE ))
        
        if [ $NEEDED_PARTS -lt 1 ]; then
          NEEDED_PARTS=1
        fi
        if [ $NEEDED_PARTS -gt 10 ]; then
          NEEDED_PARTS=10
        fi
        
        echo "ðŸ“¦ Splitting ${SIZE} bytes into ${NEEDED_PARTS} parts"
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ñ‡Ð°ÑÑ‚Ð¸ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ
        rm -f workspace_part_*
        split -b ${PART_SIZE} /tmp/workspace_backup.tar.gz workspace_part_
        
        # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ð¸ Ð¿ÑƒÑˆÐ¸Ð¼
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        git add workspace_part_*
        git status
        git commit -m "workspace: auto-save $(date +%Y%m%d-%H%M%S)" || echo "ðŸ¤· No changes to commit"
        git push origin HEAD
        
        echo "âœ… Workspace saved in ${NEEDED_PARTS} parts"
        
        # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð¿ÑƒÑˆ Ð¸ ÑƒÐ±Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
        sleep 30
        kill $SERVEOPID 2>/dev/null || true
        echo "ðŸ”„ Serveo stopped, ready for restart"

    - name: Force new workflow
      if: always()
      run: |
        echo "ðŸš€ Triggering new workflow..."
        sleep 5
