name: Serveo Tunnel with Persistence

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  serveo:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Restore workspace
      run: |
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        if [ -f workspace.tar.gz ]; then
          tar -xzf workspace.tar.gz -C /home/runner/
          echo "‚úÖ Workspace restored"
        else
          echo "üÜï No previous workspace found"
        fi

    - name: Install and setup SSH server
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server openssh-client
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è none
        sudo useradd -m -s /bin/bash none
        echo "none:h4ck3d" | sudo chpasswd
        
        # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        sudo chown -R none:none /home/none
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
        echo "AllowUsers none" | sudo tee -a /etc/ssh/sshd_config
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º SSH —Å–µ—Ä–≤–µ—Ä
        sudo service ssh start

    - name: Start Serveo tunnel
      run: |
        ssh -o StrictHostKeyChecking=no -R github-runner:22:localhost:22 serveo.net

    - name: Save workspace
      if: always()
      run: |
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        tar -czf workspace.tar.gz /home/none/
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add workspace.tar.gz
        git commit -m "Save workspace $(date)" || echo "No changes to commit"
        git push
