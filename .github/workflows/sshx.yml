name: SSHX Tunnel with Telegram Notification

on:
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub

jobs:
  sshx-tunnel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install SSHX
      run: |
        curl -sSf https://sshx.io/get | sh
        echo "$HOME/.sshx/bin" >> $GITHUB_PATH

    - name: Start SSHX tunnel and get URL
      id: sshx
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º SSHX –∏ –ø–æ–ª—É—á–∞–µ–º URL
        sshx_output=$(sshx)
        echo "$sshx_output"
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º URL –∏–∑ –≤—ã–≤–æ–¥–∞ (–æ–±—ã—á–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ https://xxx.sshx.io)
        sshx_url=$(echo "$sshx_output" | grep -o 'https://[^ ]*\.sshx\.io' | head -1)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
        echo "url=$sshx_url" >> $GITHUB_OUTPUT
        echo "SSHX_URL=$sshx_url" >> $GITHUB_ENV

    - name: Send Telegram notification
      env:
        TELEGRAM_API_TOKEN: "8179030443:AAEL8dF4cxeAQ3bLbsb_CrAHI2nfcWK12XE"
        CHAT_ID: "7309086003"
      run: |
        MESSAGE="üöÄ SSHX tunnel established!%0A%0Aüîó URL: $SSHX_URL%0A‚è∞ Active for 6 hours%0A%0Aüìä Workflow: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_API_TOKEN/sendMessage" \
          -d chat_id="$CHAT_ID" \
          -d text="$MESSAGE" \
          -d disable_web_page_preview=false

    - name: Keep tunnel active for 6 hours
      run: |
        echo "üîÑ SSHX tunnel is active at: $SSHX_URL"
        echo "‚è≥ Waiting for 6 hours (21600 seconds)..."
        sleep 21600
        echo "‚úÖ 6 hours have passed. Tunnel session completed."

    - name: Send completion notification
      if: always()
      env:
        TELEGRAM_API_TOKEN: "8179030443:AAEL8dF4cxeAQ3bLbsb_CrAHI2nfcWK12XE"
        CHAT_ID: "7309086003"
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          MESSAGE="‚úÖ SSHX tunnel session completed after 6 hours%0A%0Aüìä Workflow: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        else
          MESSAGE="‚ùå SSHX tunnel finished with status: ${{ job.status }}%0A%0Aüìä Workflow: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_API_TOKEN/sendMessage" \
          -d chat_id="$CHAT_ID" \
          -d text="$MESSAGE" \
          -d disable_web_page_preview=true
